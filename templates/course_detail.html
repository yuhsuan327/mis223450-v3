<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>{% if course %}{{ course.name }} - èª²ç¨‹è©³æƒ…{% else %}èª²ç¨‹è©³æƒ…{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

{% include 'navbar.html' %}

<div class="container-sm py-5">
  {% if course %}
    <!-- ğŸ“˜ èª²ç¨‹åŸºæœ¬è³‡æ–™ -->
    <div class="card shadow-sm p-4 mb-4">
      <h3 class="text-primary">{{ course.name }}</h3>
      <p class="text-muted">ğŸ—“ æ—¥æœŸï¼š{{ course.date }}</p>
      <p class="mb-0">ğŸ“– {{ course.description|default:"ï¼ˆæ­¤èª²ç¨‹å°šç„¡ç°¡ä»‹ï¼‰" }}</p>
    </div>

    <!-- ğŸ”Š ä¸Šå‚³éŸ³æª”è¡¨å–® -->
    <div class="card shadow-sm p-4 mb-4">
      <h5 class="text-success">ğŸ¤ ä¸Šå‚³éŸ³æª”ä¸¦ç”¢ç”Ÿæ‘˜è¦åŠæ¸¬é©—è€ƒé¡Œ</h5>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label for="lecture_title" class="form-label">å–®å…ƒåç¨±</label>
          <input type="text" name="lecture_title" id="lecture_title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="id_audio_file" class="form-label">é¸æ“‡éŸ³æª”</label>
          <input type="file" name="audio_file" id="id_audio_file" class="form-control" required>
        </div>

        <!-- é¡Œå‹ -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="num_mcq" class="form-label">é¸æ“‡é¡Œæ•¸é‡</label>
            <input type="number" name="num_mcq" id="num_mcq" class="form-control" value="5" min="0">
          </div>
          <div class="col-md-6">
            <label for="num_tf" class="form-label">æ˜¯éé¡Œæ•¸é‡</label>
            <input type="number" name="num_tf" id="num_tf" class="form-control" value="0" min="0">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">ç”¢ç”Ÿæ‘˜è¦åŠæ¸¬é©—è€ƒé¡Œ</button>
      </form>
    </div>

<!-- ğŸ™ï¸ éŒ„éŸ³å¡ç‰‡ -->
<div class="card shadow-sm p-4 mb-4">
  <h5 class="text-danger">ğŸ™ï¸ ç›´æ¥éŒ„éŸ³ä¸¦ç”¢ç”Ÿæ‘˜è¦åŠæ¸¬é©—è€ƒé¡Œ</h5>

  <div class="mb-2">
    <label for="lecture_title_record" class="form-label">å–®å…ƒåç¨±</label>
    <input type="text" id="lecture_title_record" class="form-control" placeholder="è«‹è¼¸å…¥å–®å…ƒåç¨±">
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label for="num_mcq_record" class="form-label">é¸æ“‡é¡Œæ•¸é‡</label>
      <input type="number" id="num_mcq_record" class="form-control" value="3" min="0">
    </div>
    <div class="col-md-6">
      <label for="num_tf_record" class="form-label">æ˜¯éé¡Œæ•¸é‡</label>
      <input type="number" id="num_tf_record" class="form-control" value="2" min="0">
    </div>
  </div>

  <!-- éŒ„éŸ³æç¤º -->
  <div id="recordStatus" class="alert alert-warning d-none">
    ğŸ”´ éŒ„éŸ³ä¸­â€¦è«‹é–‹å§‹è¬›èª²ï¼ˆ<span id="recordTime">00:00</span>ï¼‰
  </div>

  <div class="d-flex flex-wrap gap-2">
    <button id="startRecord" class="btn btn-danger">ğŸ”´ é–‹å§‹éŒ„éŸ³</button>
    <button id="stopRecord" class="btn btn-secondary" disabled>â¹ åœæ­¢éŒ„éŸ³</button>
  </div>
</div>

    <!-- ğŸ“š å·²ä¸Šå‚³å–®å…ƒæ¸…å–® -->
    <div class="card shadow-sm p-4">
      <h5 class="text-primary mb-3">ğŸ“š å·²ä¸Šå‚³å–®å…ƒ</h5>
      {% if lectures %}
        <ul class="list-group">
          {% for lec in lectures %}
            <li class="list-group-item">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                <div class="mb-2 mb-md-0">
                  <strong>å–®å…ƒ #{{ lec.id }}</strong> - {{ lec.date|date:"Y-m-d" }}<br>
                  <span class="text-muted">{{ lec.summary|truncatechars:40|default:"(å°šç„¡æ‘˜è¦)" }}</span>
                </div>
                <div class="d-flex flex-wrap gap-2">
                  <a href="{% url 'lecture_detail' lec.id %}" class="btn btn-outline-primary btn-sm">æŸ¥çœ‹æ‘˜è¦</a>
                  <a href="{% url 'edit_lecture_title' lec.id %}" class="btn btn-outline-info btn-sm">æ›´æ”¹å–®å…ƒåç¨±</a>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">å°šæœªä¸Šå‚³ä»»ä½•å–®å…ƒã€‚</p>
      {% endif %}
    </div>
  {% else %}
    <!-- âš  å°šæœªé¸æ“‡èª²ç¨‹ -->
    <div class="alert alert-warning text-center p-4 shadow-sm">
      <h4 class="mb-3">âš  å°šæœªæŒ‡å®šèª²ç¨‹</h4>
      <p>è«‹å¾èª²ç¨‹ç¸½è¦½ä¸­é¸æ“‡ä¸€é–€èª²ç¨‹ä¾†æŸ¥çœ‹å–®å…ƒèˆ‡æ“ä½œåŠŸèƒ½ã€‚</p>
      <a href="{% url 'lecture_list' %}" class="btn btn-outline-primary">è¿”å›èª²ç¨‹ç¸½è¦½</a>
    </div>
  {% endif %}
</div>

<!-- ğŸ™ï¸ éŒ„éŸ³åŠŸèƒ½ JS -->
<script>
let mediaRecorder, stream, lectureId = null;
let transcript = '';
let chunkInterval;

document.getElementById("startRecord").onclick = async () => {
  const title = document.getElementById("lecture_title_record").value.trim();
  const courseId = "{{ course.id }}";

  if (!title) return alert("âš  è«‹è¼¸å…¥å–®å…ƒåç¨±");

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

  mediaRecorder.ondataavailable = async (e) => {
    const formData = new FormData();
    formData.append('audio_chunk', e.data, 'chunk.webm');
    formData.append('lecture_title', title);
    formData.append('course_id', courseId);

    const res = await fetch('/api/live_chunk_upload/', { method: 'POST', body: formData });
    const result = await res.json();

    if (result.transcript) {
      transcript += result.transcript + '\n';
      document.getElementById("transcriptPreview").innerText = transcript;
    }
    if (result.lecture_id) lectureId = result.lecture_id;
  };

  mediaRecorder.start();
  chunkInterval = setInterval(() => {
    if (mediaRecorder.state === 'recording') {
      mediaRecorder.requestData();
    }
  }, 15000);

  document.getElementById("startRecord").disabled = true;
  document.getElementById("stopRecord").disabled = false;
};

document.getElementById("stopRecord").onclick = async () => {
  clearInterval(chunkInterval);
  mediaRecorder.stop();
  stream.getTracks().forEach(t => t.stop());

  document.getElementById("stopRecord").disabled = true;

if (lectureId) {
  await fetch(`/api/finalize_transcript_summary_quiz/${lectureId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      num_mcq: document.getElementById("num_mcq_record").value,
      num_tf: document.getElementById("num_tf_record").value,
    })
  });
  location.href = `/lecture/${lectureId}/`;
}
};
</script>

</body>
</html>