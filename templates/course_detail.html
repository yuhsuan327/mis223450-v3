<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>{% if course %}{{ course.name }} - èª²ç¨‹è©³æƒ…{% else %}èª²ç¨‹è©³æƒ…{% endif %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ç­‰å¾…è™•ç†ä»‹é¢æ¨£å¼ */
        
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .spinner-container {
            margin: 1.5rem 0;
        }
        
        .spinner-border {
            width: 4rem;
            height: 4rem;
            border-width: 0.4rem;
        }
        
        .processing-steps {
            margin-top: 1.5rem;
            text-align: left;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .processing-step {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            color: #6c757d;
            transition: color 0.3s;
        }
        
        .processing-step.active {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .processing-step.completed {
            color: #198754;
        }
        
        .step-icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        
        .pulse-animation {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="bg-light">

    {% include 'navbar.html' %}

    <!-- ğŸ”„ ç­‰å¾…è™•ç†ä»‹é¢ -->
    <div id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <h5 class="fw-bold mb-2 text-primary">ğŸ¤– AI å°åŠ©æ•™æ­£åœ¨åˆ†æä¸­...</h5>
            <div class="spinner-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è™•ç†ä¸­...</span>
                </div>
            </div>

            <!-- è™•ç†æ­¥é©Ÿé¡¯ç¤º -->
            <div class="processing-steps">
                <div class="processing-step" id="step-transcribe">
                    <span class="step-icon">ğŸ¤</span>
                    <span>èªéŸ³è½‰éŒ„</span>
                </div>
                <div class="processing-step" id="step-summary">
                    <span class="step-icon">ğŸ“</span>
                    <span>æ‘˜è¦ç”Ÿæˆ</span>
                </div>
                <div class="processing-step" id="step-quiz">
                    <span class="step-icon">âœï¸</span>
                    <span>å‡ºé¡Œä¸­</span>
                </div>
            </div>

            <p class="text-muted mt-3 mb-0 small">
                âš ï¸ è«‹å‹¿é—œé–‰æˆ–é‡æ–°æ•´ç†é é¢
            </p>
        </div>
    </div>

    <div class="container-sm py-5">
        {% if course %}
        <!-- ğŸ“˜ èª²ç¨‹åŸºæœ¬è³‡æ–™ -->
        <div class="card shadow-sm p-4 mb-4">
            <h3 class="text-primary">{{ course.name }}</h3>
            <p class="text-muted">ğŸ—“ æ—¥æœŸï¼š{{ course.date }}</p>
            <p class="mb-0">ğŸ“– {{ course.description|default:"(æ­¤èª²ç¨‹å°šç„¡ç°¡ä»‹)" }}</p>
        </div>

        <!-- ğŸ”Š ä¸Šå‚³éŸ³æª”è¡¨å–® -->
        <div class="card shadow-sm p-4 mb-4">
            <h5 class="text-success">ğŸ¤ ä¸Šå‚³éŸ³æª”ä¸¦ç”¢ç”Ÿæ‘˜è¦åŠæ¸¬é©—è€ƒé¡Œ</h5>
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="lecture_title" class="form-label">å–®å…ƒåç¨±</label>
                    <input type="text" name="lecture_title" id="lecture_title" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="id_audio_file" class="form-label">é¸æ“‡éŸ³æª”</label>
                    <input type="file" name="audio_file" id="id_audio_file" class="form-control" required>
                </div>

                <!-- é¡Œå‹ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="num_mcq" class="form-label">é¸æ“‡é¡Œæ•¸é‡</label>
                        <input type="number" name="num_mcq" id="num_mcq" class="form-control" value="5" min="0">
                    </div>
                    <div class="col-md-6">
                        <label for="num_tf" class="form-label">æ˜¯éé¡Œæ•¸é‡</label>
                        <input type="number" name="num_tf" id="num_tf" class="form-control" value="0" min="0">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100">ç”¢ç”Ÿæ‘˜è¦åŠæ¸¬é©—è€ƒé¡Œ</button>
            </form>
        </div>

        <!-- ğŸ™ï¸ éŒ„éŸ³å¡ç‰‡ -->
        <div class="card shadow-sm p-4 mb-4">
            <h5 class="text-danger">ğŸ™ï¸ ç›´æ¥éŒ„éŸ³ä¸¦ç”¢ç”Ÿæ‘˜è¦åŠæ¸¬é©—è€ƒé¡Œ</h5>

            <div class="mb-2">
                <label for="lecture_title_record" class="form-label">å–®å…ƒåç¨±</label>
                <input type="text" id="lecture_title_record" class="form-control" placeholder="è«‹è¼¸å…¥å–®å…ƒåç¨±">
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="num_mcq_record" class="form-label">é¸æ“‡é¡Œæ•¸é‡</label>
                    <input type="number" id="num_mcq_record" class="form-control" value="3" min="0">
                </div>
                <div class="col-md-6">
                    <label for="num_tf_record" class="form-label">æ˜¯éé¡Œæ•¸é‡</label>
                    <input type="number" id="num_tf_record" class="form-control" value="2" min="0">
                </div>
            </div>

            <!-- éŒ„éŸ³æç¤º -->
            <div id="recordStatus" class="alert alert-warning d-none">
                ğŸ”´ éŒ„éŸ³ä¸­â€¦è«‹é–‹å§‹è¬›èª²(<span id="recordTime">00:00</span>)
            </div>

            <div class="d-flex flex-wrap gap-2">
                <button id="startRecord" class="btn btn-danger">ğŸ”´ é–‹å§‹éŒ„éŸ³</button>
                <button id="stopRecord" class="btn btn-secondary" disabled>â¹ åœæ­¢éŒ„éŸ³</button>
            </div>
        </div>

        <!-- ğŸ“š å·²ä¸Šå‚³å–®å…ƒæ¸…å–® -->
        <div class="card shadow-sm p-4">
            <h5 class="text-primary mb-3">ğŸ“š å·²ä¸Šå‚³å–®å…ƒ</h5>
            {% if lectures %}
            <ul class="list-group">
                {% for lec in lectures %}
                <li class="list-group-item">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <div class="mb-2 mb-md-0">
                            <strong>å–®å…ƒ #{{ lec.id }}</strong> - {{ lec.date|date:"Y-m-d" }}<br>
                            <span class="text-muted">{{ lec.summary|truncatechars:40|default:"(å°šç„¡æ‘˜è¦)" }}</span>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{% url 'lecture_detail' lec.id %}" class="btn btn-outline-primary btn-sm">æŸ¥çœ‹æ‘˜è¦</a>
                            <a href="{% url 'edit_lecture_title' lec.id %}" class="btn btn-outline-info btn-sm">æ›´æ”¹å–®å…ƒåç¨±</a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">å°šæœªä¸Šå‚³ä»»ä½•å–®å…ƒã€‚</p>
            {% endif %}
        </div>
        {% else %}
        <!-- âš  å°šæœªé¸æ“‡èª²ç¨‹ -->
        <div class="alert alert-warning text-center p-4 shadow-sm">
            <h4 class="mb-3">âš  å°šæœªæŒ‡å®šèª²ç¨‹</h4>
            <p>è«‹å¾èª²ç¨‹ç¸½è¦½ä¸­é¸æ“‡ä¸€é–€èª²ç¨‹ä¾†æŸ¥çœ‹å–®å…ƒèˆ‡æ“ä½œåŠŸèƒ½ã€‚</p>
            <a href="{% url 'lecture_list' %}" class="btn btn-outline-primary">è¿”å›èª²ç¨‹ç¸½è¦½</a>
        </div>
        {% endif %}
    </div>

    <!-- ğŸ™ï¸ éŒ„éŸ³åŠŸèƒ½ JS -->
    <script>
        let mediaRecorder, stream, lectureId = null;
        let transcript = '';
        let chunkInterval;
        let recordSeconds = 0;
        let recordTimer = null;

        function formatTime(seconds) {
            const min = String(Math.floor(seconds / 60)).padStart(2, '0');
            const sec = String(seconds % 60).padStart(2, '0');
            return `${min}:${sec}`;
        }

        // âœ… é¡¯ç¤ºç­‰å¾…ä»‹é¢ (type: 'upload' æˆ– 'record')
        function showLoading(type) {
            const overlay = document.getElementById('loadingOverlay');
            const stepTranscribe = document.getElementById('step-transcribe');
            const stepSummary = document.getElementById('step-summary');
            const stepQuiz = document.getElementById('step-quiz');

            // é‡ç½®æ‰€æœ‰æ­¥é©Ÿç‹€æ…‹
            stepTranscribe.classList.remove('active', 'completed');
            stepSummary.classList.remove('active', 'completed');
            stepQuiz.classList.remove('active', 'completed');

            overlay.style.display = 'flex';

            if (type === 'upload') {
                // ä¸Šå‚³éŸ³æª”ï¼šé¡¯ç¤ºå…¨éƒ¨ä¸‰å€‹æ­¥é©Ÿ
                stepTranscribe.classList.add('active', 'pulse-animation');

                setTimeout(() => {
                    stepTranscribe.classList.remove('active', 'pulse-animation');
                    stepTranscribe.classList.add('completed');
                    stepSummary.classList.add('active', 'pulse-animation');
                }, 3000);

                setTimeout(() => {
                    stepSummary.classList.remove('active', 'pulse-animation');
                    stepSummary.classList.add('completed');
                    stepQuiz.classList.add('active', 'pulse-animation');
                }, 6000);
            } else if (type === 'record') {
                // éŒ„éŸ³ï¼šåªé¡¯ç¤ºæ‘˜è¦å’Œå‡ºé¡Œ
                stepTranscribe.style.display = 'none';
                stepSummary.classList.add('active', 'pulse-animation');

                setTimeout(() => {
                    stepSummary.classList.remove('active', 'pulse-animation');
                    stepSummary.classList.add('completed');
                    stepQuiz.classList.add('active', 'pulse-animation');
                }, 3000);
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // âœ… ä¸Šå‚³éŸ³æª”è¡¨å–®æäº¤è™•ç†
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const title = formData.get('lecture_title');
            const audioFile = formData.get('audio_file');

            if (!title || !audioFile) {
                alert('âš  è«‹å¡«å¯«å–®å…ƒåç¨±ä¸¦é¸æ“‡éŸ³æª”');
                return;
            }

            // é¡¯ç¤ºç­‰å¾…ç•«é¢
            showLoading('upload');

            // æäº¤è¡¨å–®
            fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.redirected) {
                        // Django redirect æœƒè‡ªå‹•è·³è½‰
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                })
                .catch(error => {
                    console.error('ä¸Šå‚³éŒ¯èª¤:', error);
                    hideLoading();
                    alert('âŒ ä¸Šå‚³å¤±æ•—,è«‹é‡è©¦');
                });
        });

        // âœ… é–‹å§‹éŒ„éŸ³
        document.getElementById("startRecord").onclick = async() => {
            const title = document.getElementById("lecture_title_record").value.trim();
            const courseId = "{{ course.id }}";

            if (!title) return alert("âš  è«‹è¼¸å…¥å–®å…ƒåç¨±");

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });

                mediaRecorder.ondataavailable = async(e) => {
                    const formData = new FormData();
                    formData.append('audio_chunk', e.data, 'chunk.webm');
                    formData.append('lecture_title', title);
                    formData.append('course_id', courseId);

                    const res = await fetch('/api/live_chunk_upload/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();

                    if (result.transcript) {
                        transcript += result.transcript + '\n';
                    }
                    if (result.lecture_id) lectureId = result.lecture_id;
                };

                mediaRecorder.start();
                chunkInterval = setInterval(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.requestData();
                    }
                }, 15000);

                // é¡¯ç¤ºéŒ„éŸ³ç‹€æ…‹
                document.getElementById("recordStatus").classList.remove("d-none");
                document.getElementById("startRecord").disabled = true;
                document.getElementById("stopRecord").disabled = false;

                // è¨ˆæ™‚å™¨
                recordSeconds = 0;
                recordTimer = setInterval(() => {
                    recordSeconds++;
                    document.getElementById("recordTime").textContent = formatTime(recordSeconds);
                }, 1000);

            } catch (error) {
                alert("âŒ ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨:" + error.message);
            }
        };

        // âœ… åœæ­¢éŒ„éŸ³ä¸¦é¡¯ç¤ºç­‰å¾…ç•«é¢
        document.getElementById("stopRecord").onclick = async() => {
            clearInterval(chunkInterval);
            clearInterval(recordTimer);
            mediaRecorder.stop();
            stream.getTracks().forEach(t => t.stop());

            document.getElementById("recordStatus").classList.add("d-none");
            document.getElementById("stopRecord").disabled = true;

            if (lectureId) {
                // é¡¯ç¤ºç­‰å¾…ç•«é¢ (éŒ„éŸ³æ¨¡å¼ï¼šåªé¡¯ç¤ºæ‘˜è¦+å‡ºé¡Œ)
                showLoading('record');

                try {
                    await fetch(`/api/finalize_transcript_summary_quiz/${lectureId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            num_mcq: document.getElementById("num_mcq_record").value,
                            num_tf: document.getElementById("num_tf_record").value,
                        })
                    });

                    // è™•ç†å®Œæˆï¼Œè·³è½‰é é¢
                    window.location.href = `/lecture/${lectureId}/`;
                } catch (error) {
                    console.error('è™•ç†éŒ¯èª¤:', error);
                    hideLoading();
                    alert('âŒ è™•ç†å¤±æ•—,è«‹é‡è©¦');
                }
            }
        };
    </script>

</body>

</html>