<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>{% if course %}{{ course.name }} - 課程詳情{% else %}課程詳情{% endif %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 等待處理介面樣式 */
        
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .spinner-container {
            margin: 1.5rem 0;
        }
        
        .spinner-border {
            width: 4rem;
            height: 4rem;
            border-width: 0.4rem;
        }
        
        .processing-steps {
            margin-top: 1.5rem;
            text-align: left;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .processing-step {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            color: #6c757d;
            transition: color 0.3s;
        }
        
        .processing-step.active {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .processing-step.completed {
            color: #198754;
        }
        
        .step-icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        
        .pulse-animation {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="bg-light">

    {% include 'navbar.html' %}

    <!-- 🔄 等待處理介面 -->
    <div id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <h5 class="fw-bold mb-2 text-primary">🤖 AI 小助教正在分析中...</h5>
            <div class="spinner-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">處理中...</span>
                </div>
            </div>

            <!-- 處理步驟顯示 -->
            <div class="processing-steps">
                <div class="processing-step" id="step-transcribe">
                    <span class="step-icon">🎤</span>
                    <span>語音轉錄</span>
                </div>
                <div class="processing-step" id="step-summary">
                    <span class="step-icon">📝</span>
                    <span>摘要生成</span>
                </div>
                <div class="processing-step" id="step-quiz">
                    <span class="step-icon">✍️</span>
                    <span>出題中</span>
                </div>
            </div>

            <p class="text-muted mt-3 mb-0 small">
                ⚠️ 請勿關閉或重新整理頁面
            </p>
        </div>
    </div>

    <div class="container-sm py-5">
        {% if course %}
        <!-- 📘 課程基本資料 -->
        <div class="card shadow-sm p-4 mb-4">
            <h3 class="text-primary">{{ course.name }}</h3>
            <p class="text-muted">🗓 日期：{{ course.date }}</p>
            <p class="mb-0">📖 {{ course.description|default:"(此課程尚無簡介)" }}</p>
        </div>

        <!-- 🔊 上傳音檔表單 -->
        <div class="card shadow-sm p-4 mb-4">
            <h5 class="text-success">🎤 上傳音檔並產生摘要及測驗考題</h5>
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="lecture_title" class="form-label">單元名稱</label>
                    <input type="text" name="lecture_title" id="lecture_title" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="id_audio_file" class="form-label">選擇音檔</label>
                    <input type="file" name="audio_file" id="id_audio_file" class="form-control" required>
                </div>

                <!-- 題型 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="num_mcq" class="form-label">選擇題數量</label>
                        <input type="number" name="num_mcq" id="num_mcq" class="form-control" value="5" min="0">
                    </div>
                    <div class="col-md-6">
                        <label for="num_tf" class="form-label">是非題數量</label>
                        <input type="number" name="num_tf" id="num_tf" class="form-control" value="0" min="0">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100">產生摘要及測驗考題</button>
            </form>
        </div>

        <!-- 🎙️ 錄音卡片 -->
        <div class="card shadow-sm p-4 mb-4">
            <h5 class="text-danger">🎙️ 直接錄音並產生摘要及測驗考題</h5>

            <div class="mb-2">
                <label for="lecture_title_record" class="form-label">單元名稱</label>
                <input type="text" id="lecture_title_record" class="form-control" placeholder="請輸入單元名稱">
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="num_mcq_record" class="form-label">選擇題數量</label>
                    <input type="number" id="num_mcq_record" class="form-control" value="3" min="0">
                </div>
                <div class="col-md-6">
                    <label for="num_tf_record" class="form-label">是非題數量</label>
                    <input type="number" id="num_tf_record" class="form-control" value="2" min="0">
                </div>
            </div>

            <!-- 錄音提示 -->
            <div id="recordStatus" class="alert alert-warning d-none">
                🔴 錄音中…請開始講課(<span id="recordTime">00:00</span>)
            </div>

            <div class="d-flex flex-wrap gap-2">
                <button id="startRecord" class="btn btn-danger">🔴 開始錄音</button>
                <button id="stopRecord" class="btn btn-secondary" disabled>⏹ 停止錄音</button>
            </div>
        </div>

        <!-- 📚 已上傳單元清單 -->
        <div class="card shadow-sm p-4">
            <h5 class="text-primary mb-3">📚 已上傳單元</h5>
            {% if lectures %}
            <ul class="list-group">
                {% for lec in lectures %}
                <li class="list-group-item">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <div class="mb-2 mb-md-0">
                            <strong>單元 #{{ lec.id }}</strong> - {{ lec.date|date:"Y-m-d" }}<br>
                            <span class="text-muted">{{ lec.summary|truncatechars:40|default:"(尚無摘要)" }}</span>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{% url 'lecture_detail' lec.id %}" class="btn btn-outline-primary btn-sm">查看摘要</a>
                            <a href="{% url 'edit_lecture_title' lec.id %}" class="btn btn-outline-info btn-sm">更改單元名稱</a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">尚未上傳任何單元。</p>
            {% endif %}
        </div>
        {% else %}
        <!-- ⚠ 尚未選擇課程 -->
        <div class="alert alert-warning text-center p-4 shadow-sm">
            <h4 class="mb-3">⚠ 尚未指定課程</h4>
            <p>請從課程總覽中選擇一門課程來查看單元與操作功能。</p>
            <a href="{% url 'lecture_list' %}" class="btn btn-outline-primary">返回課程總覽</a>
        </div>
        {% endif %}
    </div>

    <!-- 🎙️ 錄音功能 JS -->
    <script>
        let mediaRecorder, stream, lectureId = null;
        let transcript = '';
        let chunkInterval;
        let recordSeconds = 0;
        let recordTimer = null;

        function formatTime(seconds) {
            const min = String(Math.floor(seconds / 60)).padStart(2, '0');
            const sec = String(seconds % 60).padStart(2, '0');
            return `${min}:${sec}`;
        }

        // ✅ 顯示等待介面 (type: 'upload' 或 'record')
        function showLoading(type) {
            const overlay = document.getElementById('loadingOverlay');
            const stepTranscribe = document.getElementById('step-transcribe');
            const stepSummary = document.getElementById('step-summary');
            const stepQuiz = document.getElementById('step-quiz');

            // 重置所有步驟狀態
            stepTranscribe.classList.remove('active', 'completed');
            stepSummary.classList.remove('active', 'completed');
            stepQuiz.classList.remove('active', 'completed');

            overlay.style.display = 'flex';

            if (type === 'upload') {
                // 上傳音檔：顯示全部三個步驟
                stepTranscribe.classList.add('active', 'pulse-animation');

                setTimeout(() => {
                    stepTranscribe.classList.remove('active', 'pulse-animation');
                    stepTranscribe.classList.add('completed');
                    stepSummary.classList.add('active', 'pulse-animation');
                }, 3000);

                setTimeout(() => {
                    stepSummary.classList.remove('active', 'pulse-animation');
                    stepSummary.classList.add('completed');
                    stepQuiz.classList.add('active', 'pulse-animation');
                }, 6000);
            } else if (type === 'record') {
                // 錄音：只顯示摘要和出題
                stepTranscribe.style.display = 'none';
                stepSummary.classList.add('active', 'pulse-animation');

                setTimeout(() => {
                    stepSummary.classList.remove('active', 'pulse-animation');
                    stepSummary.classList.add('completed');
                    stepQuiz.classList.add('active', 'pulse-animation');
                }, 3000);
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ✅ 上傳音檔表單提交處理
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const title = formData.get('lecture_title');
            const audioFile = formData.get('audio_file');

            if (!title || !audioFile) {
                alert('⚠ 請填寫單元名稱並選擇音檔');
                return;
            }

            // 顯示等待畫面
            showLoading('upload');

            // 提交表單
            fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.redirected) {
                        // Django redirect 會自動跳轉
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                })
                .catch(error => {
                    console.error('上傳錯誤:', error);
                    hideLoading();
                    alert('❌ 上傳失敗,請重試');
                });
        });

        // ✅ 開始錄音
        document.getElementById("startRecord").onclick = async() => {
            const title = document.getElementById("lecture_title_record").value.trim();
            const courseId = "{{ course.id }}";

            if (!title) return alert("⚠ 請輸入單元名稱");

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });

                mediaRecorder.ondataavailable = async(e) => {
                    const formData = new FormData();
                    formData.append('audio_chunk', e.data, 'chunk.webm');
                    formData.append('lecture_title', title);
                    formData.append('course_id', courseId);

                    const res = await fetch('/api/live_chunk_upload/', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();

                    if (result.transcript) {
                        transcript += result.transcript + '\n';
                    }
                    if (result.lecture_id) lectureId = result.lecture_id;
                };

                mediaRecorder.start();
                chunkInterval = setInterval(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.requestData();
                    }
                }, 15000);

                // 顯示錄音狀態
                document.getElementById("recordStatus").classList.remove("d-none");
                document.getElementById("startRecord").disabled = true;
                document.getElementById("stopRecord").disabled = false;

                // 計時器
                recordSeconds = 0;
                recordTimer = setInterval(() => {
                    recordSeconds++;
                    document.getElementById("recordTime").textContent = formatTime(recordSeconds);
                }, 1000);

            } catch (error) {
                alert("❌ 無法啟動麥克風:" + error.message);
            }
        };

        // ✅ 停止錄音並顯示等待畫面
        document.getElementById("stopRecord").onclick = async() => {
            clearInterval(chunkInterval);
            clearInterval(recordTimer);
            mediaRecorder.stop();
            stream.getTracks().forEach(t => t.stop());

            document.getElementById("recordStatus").classList.add("d-none");
            document.getElementById("stopRecord").disabled = true;

            if (lectureId) {
                // 顯示等待畫面 (錄音模式：只顯示摘要+出題)
                showLoading('record');

                try {
                    await fetch(`/api/finalize_transcript_summary_quiz/${lectureId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            num_mcq: document.getElementById("num_mcq_record").value,
                            num_tf: document.getElementById("num_tf_record").value,
                        })
                    });

                    // 處理完成，跳轉頁面
                    window.location.href = `/lecture/${lectureId}/`;
                } catch (error) {
                    console.error('處理錯誤:', error);
                    hideLoading();
                    alert('❌ 處理失敗,請重試');
                }
            }
        };
    </script>

</body>

</html>