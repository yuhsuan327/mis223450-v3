<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>{% if course %}{{ course.name }} - 課程詳情{% else %}課程詳情{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

{% include 'navbar.html' %}

<div class="container-sm py-5">
  {% if course %}
    <!-- 📘 課程基本資料 -->
    <div class="card shadow-sm p-4 mb-4">
      <h3 class="text-primary">{{ course.name }}</h3>
      <p class="text-muted">🗓 日期：{{ course.date }}</p>
      <p class="mb-0">📖 {{ course.description|default:"（此課程尚無簡介）" }}</p>
    </div>

    <!-- 🔊 上傳音檔表單 -->
    <div class="card shadow-sm p-4 mb-4">
      <h5 class="text-success">🎤 上傳音檔並產生摘要及測驗考題</h5>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label for="lecture_title" class="form-label">單元名稱</label>
          <input type="text" name="lecture_title" id="lecture_title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="id_audio_file" class="form-label">選擇音檔</label>
          <input type="file" name="audio_file" id="id_audio_file" class="form-control" required>
        </div>

        <!-- 題型 -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="num_mcq" class="form-label">選擇題數量</label>
            <input type="number" name="num_mcq" id="num_mcq" class="form-control" value="5" min="0">
          </div>
          <div class="col-md-6">
            <label for="num_tf" class="form-label">是非題數量</label>
            <input type="number" name="num_tf" id="num_tf" class="form-control" value="0" min="0">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">產生摘要及測驗考題</button>
      </form>
    </div>

<!-- 🎙️ 錄音卡片 -->
<div class="card shadow-sm p-4 mb-4">
  <h5 class="text-danger">🎙️ 直接錄音並產生摘要及測驗考題</h5>

  <div class="mb-2">
    <label for="lecture_title_record" class="form-label">單元名稱</label>
    <input type="text" id="lecture_title_record" class="form-control" placeholder="請輸入單元名稱">
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label for="num_mcq_record" class="form-label">選擇題數量</label>
      <input type="number" id="num_mcq_record" class="form-control" value="3" min="0">
    </div>
    <div class="col-md-6">
      <label for="num_tf_record" class="form-label">是非題數量</label>
      <input type="number" id="num_tf_record" class="form-control" value="2" min="0">
    </div>
  </div>

  <!-- 錄音提示 -->
  <div id="recordStatus" class="alert alert-warning d-none">
    🔴 錄音中…請開始講課（<span id="recordTime">00:00</span>）
  </div>

  <div class="d-flex flex-wrap gap-2">
    <button id="startRecord" class="btn btn-danger">🔴 開始錄音</button>
    <button id="stopRecord" class="btn btn-secondary" disabled>⏹ 停止錄音</button>
  </div>
</div>

    <!-- 📚 已上傳單元清單 -->
    <div class="card shadow-sm p-4">
      <h5 class="text-primary mb-3">📚 已上傳單元</h5>
      {% if lectures %}
        <ul class="list-group">
          {% for lec in lectures %}
            <li class="list-group-item">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                <div class="mb-2 mb-md-0">
                  <strong>單元 #{{ lec.id }}</strong> - {{ lec.date|date:"Y-m-d" }}<br>
                  <span class="text-muted">{{ lec.summary|truncatechars:40|default:"(尚無摘要)" }}</span>
                </div>
                <div class="d-flex flex-wrap gap-2">
                  <a href="{% url 'lecture_detail' lec.id %}" class="btn btn-outline-primary btn-sm">查看摘要</a>
                  <a href="{% url 'edit_lecture_title' lec.id %}" class="btn btn-outline-info btn-sm">更改單元名稱</a>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">尚未上傳任何單元。</p>
      {% endif %}
    </div>
  {% else %}
    <!-- ⚠ 尚未選擇課程 -->
    <div class="alert alert-warning text-center p-4 shadow-sm">
      <h4 class="mb-3">⚠ 尚未指定課程</h4>
      <p>請從課程總覽中選擇一門課程來查看單元與操作功能。</p>
      <a href="{% url 'lecture_list' %}" class="btn btn-outline-primary">返回課程總覽</a>
    </div>
  {% endif %}
</div>

<!-- 🎙️ 錄音功能 JS -->
<script>
let mediaRecorder, stream, lectureId = null;
let transcript = '';
let chunkInterval;

document.getElementById("startRecord").onclick = async () => {
  const title = document.getElementById("lecture_title_record").value.trim();
  const courseId = "{{ course.id }}";

  if (!title) return alert("⚠ 請輸入單元名稱");

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

  mediaRecorder.ondataavailable = async (e) => {
    const formData = new FormData();
    formData.append('audio_chunk', e.data, 'chunk.webm');
    formData.append('lecture_title', title);
    formData.append('course_id', courseId);

    const res = await fetch('/api/live_chunk_upload/', { method: 'POST', body: formData });
    const result = await res.json();

    if (result.transcript) {
      transcript += result.transcript + '\n';
      document.getElementById("transcriptPreview").innerText = transcript;
    }
    if (result.lecture_id) lectureId = result.lecture_id;
  };

  mediaRecorder.start();
  chunkInterval = setInterval(() => {
    if (mediaRecorder.state === 'recording') {
      mediaRecorder.requestData();
    }
  }, 15000);

  document.getElementById("startRecord").disabled = true;
  document.getElementById("stopRecord").disabled = false;
};

document.getElementById("stopRecord").onclick = async () => {
  clearInterval(chunkInterval);
  mediaRecorder.stop();
  stream.getTracks().forEach(t => t.stop());

  document.getElementById("stopRecord").disabled = true;

if (lectureId) {
  await fetch(`/api/finalize_transcript_summary_quiz/${lectureId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      num_mcq: document.getElementById("num_mcq_record").value,
      num_tf: document.getElementById("num_tf_record").value,
    })
  });
  location.href = `/lecture/${lectureId}/`;
}
};
</script>

</body>
</html>